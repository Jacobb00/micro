groups:
  - name: microservices
    rules:
      # Request rate by service
      - record: service:http_requests:rate5m
        expr: rate(http_requests_total[5m])

      # Error rate by service
      - record: service:http_errors:rate5m
        expr: rate(http_requests_total{status=~"5.."}[5m])

      # 95th percentile latency by service
      - record: service:http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      # Memory usage percentage
      - record: node:memory_usage_percent
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

      # CPU usage percentage
      - record: node:cpu_usage_percent
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      # RabbitMQ queue size
      - record: rabbitmq:queue_messages
        expr: rabbitmq_queue_messages 